name: Audit Story

on:
  workflow_dispatch:
    inputs:
      date:
        description: "Issue date (YYYY-MM-DD)"
        required: true
        type: string
      title:
        description: "Exact story title"
        required: true
        type: string

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    concurrency:
      group: audit-story
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Authorize actor
        env:
          AUDIT_ALLOWED_ACTORS: ${{ vars.AUDIT_ALLOWED_ACTORS }}
          REPO_OWNER: ${{ github.repository_owner }}
          ACTOR: ${{ github.actor }}
        run: |
          echo "Actor: $ACTOR"
          # Default: only the repo owner may run audits.
          allowed_csv="$AUDIT_ALLOWED_ACTORS"
          if [ -z "$allowed_csv" ]; then
            allowed_csv="$REPO_OWNER"
          else
            allowed_csv="$allowed_csv,$REPO_OWNER"
          fi

          # normalize: lowercase, remove spaces
          allowed_csv="$(echo "$allowed_csv" | tr '[:upper:]' '[:lower:]' | tr -d ' ' )"
          actor_lc="$(echo "$ACTOR" | tr '[:upper:]' '[:lower:]')"

          IFS=',' read -r -a allowed <<< "$allowed_csv"
          ok=0
          for u in "${allowed[@]}"; do
            if [ -n "$u" ] && [ "$u" = "$actor_lc" ]; then
              ok=1
              break
            fi
          done

          if [ "$ok" -ne 1 ]; then
            echo "Not authorized to run audit workflow."
            echo "Set repo variable AUDIT_ALLOWED_ACTORS (comma-separated GitHub usernames) to expand access."
            exit 1
          fi

      - name: Audit story (Haiku) and merge into codex
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python audit_story.py --date "${{ inputs.date }}" --title "${{ inputs.title }}"

      - name: Commit and push changes
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add codex.json
          git commit -m "Audit: ${{ inputs.date }} â€” ${{ inputs.title }}"
          git push
